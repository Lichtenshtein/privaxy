name: CI
on:
  workflow_dispatch:

jobs:
  build-mipsel:
    name: Build for Mipsel (GNU/Padavan)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [mipsel-unknown-linux-musl]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust Nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          # targets: mipsel-unknown-linux-musl
          components: rust-src, clippy

      - name: Install Cross-Compilation Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mipsel-linux-gnu g++-mipsel-linux-gnu libc6-dev-mipsel-cross

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      # - name: Install Cross
        # run: cargo install cross --git https://github.com/cross-rs/cross.git

      - name: Prepare Toolchain and libunwind
        id: prepare
        run: |
          # 1. Download Toolchain
          # wget -q https://musl.cc/mips-linux-muslsf-cross.tgz
          wget -q  https://github.com/NordSecurity/rust_build_utils/releases/download/mirror_mipsel-linux-muslsf-cross.tgz/mipsel-linux-muslsf-cross.tgz
          tar -xzf mipsel-linux-muslsf-cross.tgz
          TOOLCHAIN_ROOT=$(pwd)/mipsel-linux-muslsf-cross
          echo "TOOLCHAIN_ROOT=$TOOLCHAIN_ROOT" >> $GITHUB_ENV

          # 2. Build libunwind (The missing link)
          wget -q https://github.com/libunwind/libunwind/releases/download/v1.8.3/libunwind-1.8.3.tar.gz
          tar -xzf libunwind-1.8.3.tar.gz
          cd libunwind-1.8.3
          sed -i.bak -e '/^#include <endian.h>/d' -e '/^# if __BYTE_ORDER == __BIG_ENDIAN/,/^# endif/c\# undef __BYTE_ORDER__\n# undef __ORDER_BIG_ENDIAN__\n# define OFFSET 0' src/mips/getcontext.S
          
          ./configure --host=mipsel-linux-muslsf \
            --enable-static \
            --disable-coredump \
            --disable-shared \
            --disable-tests \
            CC="$TOOLCHAIN_ROOT/bin/mipsel-linux-muslsf-gcc" \
            CCAS="$TOOLCHAIN_ROOT/bin/mipsel-linux-muslsf-gcc" \
            CCASFLAGS="-c"
          
          # Only build the 'src' directory to avoid compiling broken tests
          make -C src -j$(nproc)
          
          # The .libs directory will be inside 'src'
          echo "LIBUNWIND_DIR=$(pwd)/src/.libs" >> $GITHUB_ENV
          cd ..

          # 3. Export Paths for Linker
          GCC_LIB_DIR=$(find "$TOOLCHAIN_ROOT" -name "libgcc.a" -exec dirname {} \; | head -n 1)
          echo "GCC_LIB_DIR=$GCC_LIB_DIR" >> $GITHUB_ENV
          echo "MUSL_LIB_DIR=$TOOLCHAIN_ROOT/mipsel-linux-muslsf/lib" >> $GITHUB_ENV

          # Ensure libgcc_eh exists for the linker
          ln -s "$GCC_LIB_DIR/libgcc.a" "$GCC_LIB_DIR/libgcc_eh.a" || true
          
      - name: Run Clippy Fix
        run: |
          cargo clippy \
            --fix --allow-dirty \
            --target mipsel-unknown-linux-musl \
            --all-targets \
            -p privaxy-app \
            -Z build-std=std,panic_abort \
            --no-default-features \
            --features "liveview" \
            -- -D warnings
        env:
          CARGO_TARGET_MIPSEL_UNKNOWN_LINUX_MUSL_LINKER: rust-lld
          RUSTFLAGS: "-Z unstable-options --cfg=force_disable_atomic64"

      - name: Build MIPS Binary
        run: |
          export RUSTFLAGS="-Z unstable-options \
            -C panic=immediate-abort \
            -C target-feature=+mips32 \
            -C target-cpu=mips32 \
            -C target-feature=+soft-float \
            -C link-self-contained=yes \
            -C target-feature=+crt-static \
            -L $LIBUNWIND_DIR \
            -L $MUSL_LIB_DIR \
            -L $GCC_LIB_DIR \
            -C link-arg=--start-group \
            -C link-arg=-static \
            -C link-arg=-lunwind \
            -C link-arg=-lunwind-mips \
            -C link-arg=-lgcc \
            -C link-arg=-lgcc_eh \
            -C link-arg=-lc \
            -C link-arg=-s \
            -C link-arg=--end-group \
            --cfg=force_disable_atomic64"

          cargo build \
            --target mipsel-unknown-linux-musl \
            --release \
            -p privaxy-app \
            -Z build-std=std,panic_abort \
            -Z unstable-options \
            --no-default-features \
            --features "liveview"
        env:
          CARGO_TARGET_MIPSEL_UNKNOWN_LINUX_MUSL_LINKER: rust-lld
          CC_mipsel_unknown_linux_musl: ${{ env.TOOLCHAIN_ROOT }}/bin/mipsel-linux-muslsf-gcc
          AR_mipsel_unknown_linux_musl: ${{ env.TOOLCHAIN_ROOT }}/bin/mipsel-linux-muslsf-ar

      - name: Create dirlist snapshot
        run: |
          find . -print | sed -e 's;[^/]*/;|___;g;s;___|; |;g' > ./post-dir-tree.txt
          find . -type f -o -type d > ./dir-files.txt

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dioxus-mipsel-musl-binary
          path: |
            target/${{ matrix.target }}/release/privaxy-app
            ./post-dir-tree.txt
            ./dir-files.txt

  # ci:
    # name: CI
    # needs: build-mipsel
    # runs-on: ${{ matrix.os }}
    # strategy:
      # matrix:
        # include:
          # - build: linux
            # os: ubuntu-latest
            # rust: nightly
            # target: mipsel-unknown-linux-gnu
    # steps:
      # - name: Checkout
        # uses: actions/checkout@v4

      # - name: Cache build artifacts
        # uses: actions/cache@v3
        # with:
          # key:  no_gui-${{ matrix.os }}-${{ matrix.target }}-artifacts
          # path: |
            # ./target
            # ~/.cargo

      # - name: Install rust
        # uses: actions-rs/toolchain@v1
        # with:
          # toolchain: ${{ matrix.rust }}
          # profile: minimal
          # override: true

      # - name: Install cross build dependencies
        # if: matrix.target == 'aarch64-unknown-linux-gnu'
        # run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross

      # - name: Install cross build dependencies
        # if: matrix.target == 'mipsel-unknown-linux-gnu'
        # run: sudo apt-get update && sudo apt-get install -y gcc-mipsel-linux-gnu g++-mipsel-linux-gnu

      # - name: Install rust target
        # run: |
          # rustc --print=target-list
          # rustup default nightly

      # - name: Set up Docker
        # uses: docker/setup-qemu-action@v3
        # with:
          # platforms: all

      # - name: Cross compile to mipsel
        # uses: actions-rs/cargo@v1
        # with:
          # use-cross: true
          # command: build
          # args: --target mipsel-unknown-linux-gnu --release -Zbuild-std --bin privaxy --target-dir target

      # - uses: actions/upload-artifact@v4
        # if: matrix.os != 'windows-latest'
        # with:
          # name: privaxy_nogui-${{ matrix.target }}
          # path: |
            # target/${{ matrix.target }}/release/privaxy

      # - uses: actions/upload-artifact@v4
        # if: matrix.os == 'windows-latest'
        # with:
          # name: privaxy_nogui-${{ matrix.target }}
          # path: |
            # target/${{ matrix.target }}/release/*
